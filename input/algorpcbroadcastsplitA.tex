\SetKwProg{Function}{function}{}{}
\SetKwProg{Upon}{upon}{}{}
\SetKwProg{Initially}{INITIALLY:}{}{}
\SetKwProg{Safety}{SAFETY:}{}{}
\SetKwProg{Dissemination}{DISSEMINATION:}{}{}

\small

\DontPrintSemicolon
\LinesNumbered

%\begin{multicols}{2}
\Initially {} {
%  $Q_o$ \tcp*{Set of processes, $p$'s outview}
%  $Q_i$ \tcp*{Set of processes, $p$'s inview}
%  \BlankLine  
  $B \leftarrow \varnothing$ \tcp*{$@$Sender Map of buffers $Q_o : M^*$}
%  \BlankLine  
  $S \leftarrow \varnothing$ \tcp*{$@$Receiver Map of buffers $Q_i : M^* \times M^* \times bool$}
}

\BlankLine

\Safety{}{
  \Upon{$\textup{open}_o(to)$} {
    $Q_o \leftarrow Q_o \setminus to$ \tcp*{unsafe to send to $to$}
    $\textup{sendAlpha}(p,\,q)$ \label{line:sendalpha} \tcp*{$\alpha$}
  }

  \Upon{$\textup{open}_i(from)$} {
    $Q_i \leftarrow Q_i \setminus from$ \tcp*{unsafe to receive from $from$}
  }

  \BlankLine
  
  \Upon{$\textup{receiveAlpha}(from,\,to)$ \tcp*[f]{$to=p$}} {
    $S[from] \leftarrow \langle \varnothing,\, \varnothing,\, false \rangle$ 
    \tcp*{initialize $B_\alpha$}
    $\textup{sendBeta}(from,\,to)$ \label{line:sendbeta} \tcp*{$\beta$}
  }

  \BlankLine

  \Upon{$\textup{receiveBeta}(from,\,to)$ \tcp*[f]{$from=p$}} {
    $B[to] \leftarrow \varnothing$ \tcp*{initialize $B_\beta$}
    $\textup{sendPi}(from,\, to)$ \label{line:sendpi} \tcp*{$\pi$}
  }
  
  \BlankLine

  \Upon{$\textup{receivePi}(from,\,to)$ \tcp*[f]{$to=p$}} {
    \textbf{let} $\langle B_\alpha ,\, B_\pi ,\, \_ \rangle \leftarrow S[from]$ \;
    $S[from] \leftarrow \langle B_\alpha,\, B_\pi,\, true \rangle$ \tcp*{initialize $B_\pi$}
    $\textup{sendRho}(from,\, to)$ \label{line:sendrho} \tcp*{$\rho$}
  }

  \BlankLine

  \Upon{$\textup{receiveRho}(from,\,to)$ \tcp*[f]{$from=p$}} {
    $\textup{sendBuffer}(from,\,to,\, B[to])$ \label{line:sendbuffer}\;
    $B \leftarrow B \setminus to$ \;
    $Q_o \leftarrow Q_o \cup to$ \tcp*{safe to send to $to$}
  }

  \BlankLine

  \Upon{$\textup{receiveBuffer}(from,\, to,\, B_\beta)$} {
    \textbf{let} $\langle B_\alpha,\, B_\pi,\, \_ \rangle \leftarrow S[from]$ \;
%    \textbf{let} $potential \leftarrow buf \setminus B_\alpha$ \;
    \lForEach {$m \in B_\beta\setminus B_\alpha \setminus B_\pi$ }
    {$\textup{receive}(m,\,from)$ \label{line:todeliver}\tcp*[f]{to deliver}}
    $D[from] \leftarrow B_\pi \setminus (B_\beta\setminus B_\alpha)$ \label{line:toexpect} \tcp*{to expect}
    $S \leftarrow S \setminus from$ \;
    $Q_i \leftarrow Q_i \cup from$ \tcp*{safe to receive from $from$}
  }
  
  \BlankLine

  \Upon{$\textup{close}_o(to)$} {
    $B \leftarrow B \setminus to$
  }
  \Upon{$\textup{close}_i(from)$} {
    $S \leftarrow S \setminus from$
  }

}

%\end{multicols}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../paper"
%%% End:
